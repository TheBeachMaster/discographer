function ovf2Xml_VirtualSystem_vboxMachine()
{
	xml_start "vbox:Machine ovf:required='false' version='1.12-macosx' uuid='${machineUuid}' name='${machine}' OSType='${machineOperatingSystemName}' snapshotFolder='Snapshots' lastStateChange='${machineLastStateChangeTimestamp}'"
		
		indented "<ovf:Info>Complete VirtualBox machine configuration in VirtualBox format</ovf:Info>"
		ovf2Xml_VirtualSystem_vboxMachine_ExtraData
		ovf2Xml_VirtualSystem_vboxMachine_Hardware
		ovf2Xml_VirtualSystem_vboxMachine_StorageControllers
		
	xml_end "vbox:Machine"
}

function ovf2Xml_VirtualSystem_vboxMachine_ExtraData()
{
	xml_start "ExtraData"
		
		xml_selfclose "ExtraDataItem name='GUI/LastCloseAction' value='PowerOff'"
		#xml_selfclose "ExtraDataItem name='GUI/LastGuestSizeHint' value='720,400'"
		#xml_selfclose "ExtraDataItem name='GUI/LastNormalWindowPosition' value='667,277,795,509'"
		
	xml_end "ExtraData"
}

function ovf2Xml_VirtualSystem_vboxMachine_Hardware()
{
	xml_start "Hardware version='2'"
		
		ovf2Xml_VirtualSystem_vboxMachine_Hardware_CPU
		ovf2Xml_VirtualSystem_vboxMachine_Hardware_Memory
		ovf2Xml_VirtualSystem_vboxMachine_Hardware_HID
		ovf2Xml_VirtualSystem_vboxMachine_Hardware_HPET
		ovf2Xml_VirtualSystem_vboxMachine_Hardware_Chipset
		ovf2Xml_VirtualSystem_vboxMachine_Hardware_Boot
		ovf2Xml_VirtualSystem_vboxMachine_Hardware_Display
		ovf2Xml_VirtualSystem_vboxMachine_Hardware_Videocapture
		ovf2Xml_VirtualSystem_vboxMachine_Hardware_RemoteDisplay
		ovf2Xml_VirtualSystem_vboxMachine_Hardware_BIOS
		ovf2Xml_VirtualSystem_vboxMachine_Hardware_USBController
		ovf2Xml_VirtualSystem_vboxMachine_Hardware_Network
		ovf2Xml_VirtualSystem_vboxMachine_Hardware_UART
		ovf2Xml_VirtualSystem_vboxMachine_Hardware_LPT
		ovf2Xml_VirtualSystem_vboxMachine_Hardware_AudioAdapter
		ovf2Xml_VirtualSystem_vboxMachine_Hardware_RTC
		ovf2Xml_VirtualSystem_vboxMachine_Hardware_SharedFolders
		ovf2Xml_VirtualSystem_vboxMachine_Hardware_Clipboard
		ovf2Xml_VirtualSystem_vboxMachine_Hardware_DragAndDrop
		ovf2Xml_VirtualSystem_vboxMachine_Hardware_IO
		ovf2Xml_VirtualSystem_vboxMachine_Hardware_HostPci
		ovf2Xml_VirtualSystem_vboxMachine_Hardware_EmulatedUSB
		ovf2Xml_VirtualSystem_vboxMachine_Hardware_Guest
		ovf2Xml_VirtualSystem_vboxMachine_Hardware_GuestProperties
		
	xml_end "Hardware"
}

function ovf2Xml_VirtualSystem_vboxMachine_Hardware_CPU()
{
	xml_start "CPU count='2' hotpluug='false'"
	
		xml_selfclose "HardwareVirtEx enabled='true'"
		xml_selfclose "HardwareVirtExNestedPaging enabled='true'"
		xml_selfclose "HardwareVirtExVPID enabled='true'"
		xml_selfclose "HardwareVirtExUX enabled='true'"
		xml_selfclose "PAE enabled='true'"
		xml_selfclose "HardwareVirtExLargePages enabled='true'"
		xml_selfclose "HardwareVirtForce enabled='false'"
	
	xml_end "CPU"
}

function ovf2Xml_VirtualSystem_vboxMachine_Hardware_Memory()
{
	xml_selfclose "Memory RAMSize='${machineRamSizeMegabytes} PageFusion='false'"
}

function ovf2Xml_VirtualSystem_vboxMachine_Hardware_HID()
{
	xml_selfclose "HID Pointing='PS2Mouse Keyboard='PS2Keyboard'"
}

function ovf2Xml_VirtualSystem_vboxMachine_Hardware_HPET()
{
	xml_selfclose "HPET enabled='false'"
}

function ovf2Xml_VirtualSystem_vboxMachine_Hardware_Chipset()
{
	# Also PIIX3
	xml_selfclose "Chipset type='ICH9'"
}

function ovf2Xml_VirtualSystem_vboxMachine_Hardware_Boot()
{
	FIXME - references item in StorageController
	
	xml_start "Boot"
		
		xml_selfclose "Order position='1' device='HardDisk'"
		xml_selfclose "Order position='2' device='None'"
		xml_selfclose "Order position='3' device='None'"
		xml_selfclose "Order position='4' device='None'"
		
	xml_end "Boot"
}

function ovf2Xml_VirtualSystem_vboxMachine_Hardware_Display()
{
	xml_selfclose "Display VRAMSize='12' monitorCount='1' accelerate3D='false' accelerate2DVideo='false'"
}

function ovf2Xml_VirtualSystem_vboxMachine_Hardware_Videocapture()
{
	xml_selfclose "VideoCapture"
}

function ovf2Xml_VirtualSystem_vboxMachine_Hardware_BIOS()
{
	xml_start "BIOS"
	
		xml_selfclose "ACPI enabled='true'"
		xml_selfclose "IOAPIC enabled='true'"
		xml_selfclose "Logo fadeIn='true' fadeOut='true' displayTime='0'"
		xml_selfclose "BootMenu mode='MessageAndMenu'"
		xml_selfclose "TimeOffset value='0'"
		xml_selfclose "PXEDebug enabled='false'"
	
	xml_end "BIOS"
}

function ovf2Xml_VirtualSystem_vboxMachine_Hardware_USBController()
{
	xml_selfclose "USBController enabled='false' enabledEhci='false'"
}

function ovf2Xml_VirtualSystem_vboxMachine_Hardware_Network()
{
	xml_start "Network"
		
		local nic
		local machineNicMac
		local ethernetControllerHardware
		local -i index=0
		for nic in "${machineNics[@]}"
		do
			machineNicMac="${machineConfigurationNicsMac[@]}"
			
			if [ "${machineConfigurationNicsVariant["$nic"]}" = "virtual" ]; then
				ethernetControllerHardware="virtio-net"
			else
				# Same as E1000, but virtualbox uses a different name here...
				ethernetControllerHardware="82540EM"
			fi
			
			xml_start "Adapter slot='${index}' enabled='true' MACAddress='${machineNicMac}' cable='true' speed='0' type='${ethernetControllerHardware}'"
				
				xml_start "DisabledModes"
					
					xml_selfclose "BridgedInterface name='en1: Wi-Fi (AirPort)'"
					xml_selfclose "InternalNetwork name='intnet'"
					xml_selfclose "NATNetwork name='NatNetwork'"
					
				xml_end "DisabledModes"
				
				xml_start "NAT"
					
					xml_selfclose "DNS pass-domain='true' use-proxy='false' use-host-resolver='false'"
					xml_selfclose "Alias logging='false' proxy-only='false' use-same-ports='false'"
					
				xml_end "NAT"
				
			xml_end "Adapter"
			
			index=$((index+1))
		done
		
	xml_end "Network"
}

function ovf2Xml_VirtualSystem_vboxMachine_Hardware_UART()
{
	# Serial Ports - incredibly rare to have more than 2 more, and unlikely we need them at all
	xml_start "UART"
		
		xml_selfclose "Port slot='0' enabled='false' IOBase='0x3f8' IRQ='4' hostMode='Disconnected'"
		xml_selfclose "Port slot='1' enabled='false' IOBase='0x2f8' IRQ='4' hostMode='Disconnected'"
		
	xml_end "UART"
}

function ovf2Xml_VirtualSystem_vboxMachine_Hardware_LPT()
{
	# Parallel Ports - unlikely to be needed at all
	xml_start "LPT"
		
		xml_selfclose "Port slot='0' enabled='false' IOBase='0x378' IRQ='7'"
		xml_selfclose "Port slot='1' enabled='false' IOBase='0x378' IRQ='7'"
		
	xml_end "LPT"
}

function ovf2Xml_VirtualSystem_vboxMachine_Hardware_AudioAdapter()
{
	xml_selfclose "AudioAdapter controller='AC97' driver='CoreAudio' enabled='false'"
}

function ovf2Xml_VirtualSystem_vboxMachine_Hardware_RTC()
{
	xml_selfclose "RTC localOrUTC='UTC'"
}

function ovf2Xml_VirtualSystem_vboxMachine_Hardware_SharedFolders()
{
	xml_start "SharedFolders"
		
		#xml_selfclose "SharedFolder name='lfs' hostPath='/absolute/path/to/folder' writable='false' autoMount='true'"
		
	xml_end "SharedFolders"
}

function ovf2Xml_VirtualSystem_vboxMachine_Hardware_Clipboard()
{
	xml_selfclose "Clipboard mode='Bidirectional'"
}

function ovf2Xml_VirtualSystem_vboxMachine_Hardware_DragAndDrop()
{
	xml_selfclose "DragAndDrop mode='Disabled'"
}

function ovf2Xml_VirtualSystem_vboxMachine_Hardware_IO()
{
	xml_start IO
		
		xml_selfclose "IoCache enabled='true' size='5'"
		xml_selfclose "BandwidthGroups"
		
	xml_end IO
}

function ovf2Xml_VirtualSystem_vboxMachine_Hardware_HostPci()
{
	xml_start HostPCI
		
		xml_selfclose "Devices"
		
	xml_end HostPCI
}

function ovf2Xml_VirtualSystem_vboxMachine_Hardware_EmulatedUSB()
{
	xml_start EmulatedUSB
	
		xml_selfclose "CardReader enabled='false'"
	
	xml_end EmulatedUSB
}

function ovf2Xml_VirtualSystem_vboxMachine_Hardware_Guest()
{
	xml_selfclose "Guest memoryBalloonSize='0'"
}

function ovf2Xml_VirtualSystem_vboxMachine_Hardware_GuestProperties()
{
	xml_start GuestProperties
		
		#xml_selfclose "GuestProperty name='/VirtualBox/GuestAdd/Revision' value='92456' timestamp='1394700173553625000' flags=''"
		#xml_selfclose "GuestProperty name='/VirtualBox/GuestAdd/Version' value='4.3.8' timestamp='1394700173552952000' flags=''"
		#xml_selfclose "GuestProperty name='/VirtualBox/GuestAdd/VersionExt' value='4.3.8' timestamp='1394700173553329000' flags=''"
		
		#xml_selfclose "GuestProperty name='/VirtualBox/GuestInfo/Net/0/MAC' value='080027D62B59' timestamp='1394700173568774000' flags=''"
		#xml_selfclose "GuestProperty name='/VirtualBox/GuestInfo/Net/0/Status' value='Up' timestamp='1394700173569029000' flags=''"
		#xml_selfclose "GuestProperty name='/VirtualBox/GuestInfo/Net/0/V4/Broadcast' value='10.0.2.255' timestamp='1394700173564802000' flags=''"
		#xml_selfclose "GuestProperty name='/VirtualBox/GuestInfo/Net/0/V4/IP' value='10.0.2.15' timestamp='1394700173564402000' flags=''"
		#xml_selfclose "GuestProperty name='/VirtualBox/GuestInfo/Net/0/V4/Netmask' value='255.255.255.0' timestamp='1394700173565175000' flags=''"
		#xml_selfclose "GuestProperty name='/VirtualBox/GuestInfo/Net/Count' value='1' timestamp='1394731816650056000' flags=''"
		
		#xml_selfclose "GuestProperty name='/VirtualBox/GuestInfo/OS/Product' value='Linux' timestamp='1394700173550587000' flags=''"
		#xml_selfclose "GuestProperty name='/VirtualBox/GuestInfo/OS/Release' value='3.11.0-18-generic' timestamp='1394700173551057000' flags=''"
		#xml_selfclose "GuestProperty name='/VirtualBox/GuestInfo/OS/Version' value='#32-Ubuntu SMP Tue Feb 18 21:11:14 UTC 2014' timestamp='1394700173551645000' flags=''"
		#xml_selfclose "GuestProperty name='/VirtualBox/HostInfo/GUI/LanguageID' value='C' timestamp='1394700148192375000' flags=''"
		
	xml_end GuestProperties
}

ovf2Xml_VirtualSystem_vboxMachine_StorageControllers()
{
	xml_start "StorageControllers"
		
		# We need to fix port count
		
		local -i index=0
		local machineSataControllerType
		for machineSataControllerType in "${machineSataControllerTypes[@]}"
		do
			xml_start "StorageController name='SATA' type='${machineSataControllerType}' PortCount='1' useHostIOCache='true' Bootable='true' IDE0MasterEmulationPort='0' IDE0SlaveEmulationPort='1' IDE1MasterEmulationPort='2' IDE1SlaveEmulationPort='3'"
			
				local -i attachedDiskIndex=0
				
				for ((attachedDiskIndex=0;attachedDiskIndex<XXXXXX;attachedDiskIndex++))
				do
					
					xml_start "AttachedDevice type='HardDisk' port='${attachedDiskIndex}' device='${attachedDiskIndex}'"
						
						# Disk id - where from?
						xml_selfclose "Image uuid='{bd8fd5dd-12b3-4598-b319-1e4d755c5630}'"
						
					xml_end "AttachedDevice"
					
				done
			
			xml_end "StorageController"
		done

		local -i index=0
		local machineIdeControllerType
		for machineIdeControllerType in "${machineIdeControllerTypes[@]}"
		do
			xml_start "StorageController name='IDE' type='${machineIdeControllerType}' PortCount='2' useHostIOCache='true' Bootable='true'"

				local -i attachedDiskIndex=0

				for ((attachedDiskIndex=0;attachedDiskIndex<XXXXXX;attachedDiskIndex++))
				do

					xml_start "AttachedDevice passthrough='false' type='DVD' port='${attachedDiskIndex}' device='${attachedDiskIndex}'"

						# Disk id - where from?
						xml_selfclose "Image uuid='{1df54585-f5d3-4932-8770-687a62473add}'"

					xml_end "AttachedDevice"

				done

			xml_end "StorageController"
		done
		
	xml_end "StorageControllers"
}


